# memberOf
- name: Search Directory for memberof overlay
  shell: "ldapsearch -QLLLY EXTERNAL -H ldapi:/// -b cn=config  olcOverlay=memberof"
  register: memberof_overlay

- name: Render template memberof-overlay.ldif
  template: 
    src: roles/slapd/templates/memberof-overlay.ldif
    dest: "{{ tmp_dir }}/memberof-overlay.ldif"

- name: Add memberOf overlay to openldap
  command: "ldapadd -Y EXTERNAL -H ldapi:/// -f {{ tmp_dir }}/memberof-overlay.ldif"
  when: memberof_overlay.stdout == ""

# ppolicy schema
- name: "Check Password Policy schema on openLDAP and store the result on 'ppolicy_schema' ansible variable"
  shell: "ldapsearch -QLLLY EXTERNAL -H ldapi:/// -b cn=schema,cn=config cn=*ppolicy dn"
  register: ppolicy_schema
  changed_when: false

- name: "Enable Password Policy Schema on OpenLDAP"
  command: "ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/ppolicy.ldif"
  when: ppolicy_schema.stdout == ""

# ppolicy overlay configuration
- name: Search Directory for ppolicy overlay
  shell: "ldapsearch -QLLLY EXTERNAL -H ldapi:/// -b cn=config  olcOverlay=ppolicy"
  register: ppolicy_overlay

- name: Render template ppolicy-overlay.ldif
  template: 
    src: roles/slapd/templates/ppolicy-overlay.ldif
    dest: "{{ tmp_dir }}/ppolicy-overlay.ldif"

- name: Add ppolicy overlay to openldap
  command: "ldapadd -Y EXTERNAL -H ldapi:/// -f {{ tmp_dir }}/ppolicy-overlay.ldif"
  when: ppolicy_overlay.stdout == ""

- name: Render template ppolicy-entry.ldif
  template: 
    src: roles/slapd/templates/ppolicy-entry.ldif
    dest: "{{ tmp_dir }}/ppolicy-entry.ldif"

- name: Add ppolicy entry
  command: "ldapadd -x -D 'cn=admin,{{ ldap_basedc }}' -w {{ ldap_pw }} -f {{ tmp_dir }}/ppolicy-entry.ldif"
  when: ppolicy_overlay.stdout == ""

# pw-sha2 overlay for SHA256 support
- name: Search Directory for pw-sha2 overlay
  shell: "ldapsearch -QLLLY EXTERNAL -H ldapi:/// -b cn=config  olcModuleLoad=pw-sha2"
  register: pwsha2

- name: Add pw-sha2 overlay for SHA256 support to openldap
  command: "ldapadd -Y EXTERNAL -H ldapi:/// -f roles/slapd/files/pw-sha2.ldif"
  when: pwsha2.stdout == ""

# monitor overlay
- name: Hashing Monitor password
  shell: "slappasswd -s {{ ldap_monitor_pw }}"
  register: ldap_monitor_pw_hash

- name: Render template monitor_backend.ldif
  template: 
    src: roles/slapd/templates/monitor_backend.ldif
    dest: "{{ tmp_dir }}/monitor_backend.ldif"

- name: Add Monitor user entry
  command: "ldapadd -Y EXTERNAL -H ldapi:/// -f {{ tmp_dir }}/monitor_backend.ldif"
